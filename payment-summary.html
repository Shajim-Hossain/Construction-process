<!DOCTYPE html>
<html>
<head>
    <title>Payment Summary</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav>
        <a href="building-info.html">Building Info</a>
        <a href="worker-log.html">Worker Log</a>
        <a href="payment-summary.html">Payment Summary</a>
    </nav>

    <div class="container">
        <h1>Payment Summary</h1>
        
        <form id="dateRangeForm">
            <label for="startDate">Start Date:</label>
            <input type="date" id="startDate" required>
            
            <label for="endDate">End Date:</label>
            <input type="date" id="endDate" required>
            
            <button type="submit">Generate Summary</button>
        </form>

        <div id="summaryResults" class="card" style="display: none;">
            <h2>Payment Summary</h2>
            <div id="dateRange"></div>
            
            <div class="summary-grid">
                <div class="summary-item">
                    <h3>Total Days</h3>
                    <p id="totalDays">0</p>
                </div>
                <div class="summary-item">
                    <h3>Master Masons</h3>
                    <p id="totalMasters">0</p>
                </div>
                <div class="summary-item">
                    <h3>Helpers</h3>
                    <p id="totalHelpers">0</p>
                </div>
                <div class="summary-item">
                    <h3>Total Workers</h3>
                    <p id="totalWorkers">0</p>
                </div>
                <div class="summary-item">
                    <h3>Master Payments</h3>
                    <p id="masterPayments">$0.00</p>
                </div>
                <div class="summary-item">
                    <h3>Helper Payments</h3>
                    <p id="helperPayments">$0.00</p>
                </div>
                <div class="summary-item total">
                    <h3>Total Payment</h3>
                    <p id="totalPayment">$0.00</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication check
        if (!localStorage.getItem('authenticated')) {
            window.location.href = 'index.html';
        }

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Form submission handler
        document.getElementById('dateRangeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            // Adjust end date to include the entire day
            endDate.setHours(23, 59, 59, 999);
            
            try {
                const querySnapshot = await db.collection('workerLogs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(startDate))
                    .where('date', '<=', firebase.firestore.Timestamp.fromDate(endDate))
                    .get();
                
                let totalMasters = 0;
                let totalHelpers = 0;
                let masterPayments = 0;
                let helperPayments = 0;
                const uniqueDays = new Set();
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const dateStr = data.date.toDate().toDateString();
                    
                    uniqueDays.add(dateStr);
                    totalMasters += data.masterMasons;
                    totalHelpers += data.helpers;
                    masterPayments += data.masterMasons * data.masterRate;
                    helperPayments += data.helpers * data.helperRate;
                });
                
                // Display results
                document.getElementById('dateRange').textContent = 
                    `${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;
                
                document.getElementById('totalDays').textContent = uniqueDays.size;
                document.getElementById('totalMasters').textContent = totalMasters;
                document.getElementById('totalHelpers').textContent = totalHelpers;
                document.getElementById('totalWorkers').textContent = totalMasters + totalHelpers;
                document.getElementById('masterPayments').textContent = `$${masterPayments.toFixed(2)}`;
                document.getElementById('helperPayments').textContent = `$${helperPayments.toFixed(2)}`;
                document.getElementById('totalPayment').textContent = 
                    `$${(masterPayments + helperPayments).toFixed(2)}`;
                
                document.getElementById('summaryResults').style.display = 'block';
            } catch (error) {
                console.error('Error fetching documents: ', error);
                alert('Error generating summary. Please try again.');
            }
        });
    </script>

    <style>
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .summary-item {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-item h3 {
            margin-top: 0;
            color: #555;
            font-size: 1rem;
        }
        
        .summary-item p {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0;
        }
        
        .summary-item.total {
            background: #4CAF50;
            color: white;
            grid-column: span 2;
        }
        
        .summary-item.total h3 {
            color: white;
        }
        
        #dateRange {
            color: #666;
            margin-bottom: 20px;
            font-style: italic;
        }
    </style>
</body>
</html>